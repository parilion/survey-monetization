# 问卷专属URL改造需求文档

## 一、背景

### 1.1 现状
- 所有问卷共用同一入口页面，用户需先输入密码才知道具体问卷
- 问卷与URL无直接关联，无法直接分享特定问卷
- 管理后台无法直接生成分发链接

### 1.2 目标
- 每个问卷拥有专属URL，如 `www.test.com/qwixn`
- 访问专属URL直接展示该问卷介绍
- 支持便捷生成分发链接，提升用户体验

---

## 二、功能需求

### 2.1 问卷专属URL
| 功能 | 说明 |
|------|------|
| URL格式 | `/{slug}`，如 `www.test.com/qwixn` |
| slug定义 | 问卷唯一短码，仅包含字母数字，推荐4-8位 |
| 访问逻辑 | 访问 `/{slug}` 自动加载对应问卷介绍和密码验证 |

### 2.2 问卷管理
| 功能 | 说明 |
|------|------|
| slug设置 | 新增/编辑问卷时支持自定义slug |
| 唯一性校验 | slug全局唯一，不允许重复 |
| 自动生成 | 可选：系统自动生成随机slug |
| URL复制 | 一键复制问卷专属URL |

### 2.3 密码分发
| 功能 | 说明 |
|------|------|
| 按问卷生成 | 生成密码时关联问卷slug |
| 密码验证 | 保持现有密码验证逻辑，自动关联问卷 |

### 2.4 H5页面优化
| 页面 | 改动 |
|------|------|
| 密码验证页 | 根据slug加载问卷介绍，强制密码输入 |
| 答题页 | 添加明确的"上一题"/"下一题"按钮导航 |

---

## 三、技术方案

### 3.1 数据库设计

#### 3.1.1 surveys 表新增字段
```sql
ALTER TABLE surveys ADD COLUMN slug VARCHAR(50) UNIQUE COMMENT '问卷短码' AFTER id;
```

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| slug | varchar(50) | UNIQUE | 问卷短码，URL路径使用 |

### 3.2 后端API

#### 3.2.1 新增接口
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/surveys/slug/:slug` | 根据slug查询问卷（含题目） |

#### 3.2.2 修改接口
| 方法 | 路径 | 改动 |
|------|------|------|
| POST | `/api/surveys` | 请求体增加 `slug` 字段 |
| PUT | `/api/surveys/:id` | 请求体增加 `slug` 字段，支持修改 |
| POST | `/api/passwords/generate` | 支持按 `surveyId` 或 `slug` 生成密码 |

### 3.3 前端改造

#### 3.3.1 H5端路由
```js
// router/index.js
routes: [
  { path: '/:slug', name: 'survey', component: () => import('@/views/PasswordVerify.vue') },
  { path: '/intro', name: 'survey-intro', component: () => import('@/views/SurveyIntro.vue') },
  { path: '/question', name: 'question', component: () => import('@/views/Question.vue') },
  { path: '/result', name: 'result', component: () => import('@/views/Result.vue') }
]
```

#### 3.3.2 H5端页面改动
| 文件 | 改动 |
|------|------|
| `PasswordVerify.vue` | 根据slug加载问卷介绍；保留密码输入 |
| `Question.vue` | 添加"上一题"/"下一题"按钮 |
| `api/index.js` | 新增 `getSurveyBySlug()` |

#### 3.3.3 管理后台改动
| 文件 | 改动 |
|------|------|
| 问卷列表 | 新增slug显示列 |
| 问卷表单 | 新增slug输入字段，校验唯一性 |
| 操作列 | 新增"复制链接"功能 |

---

## 四、开发任务清单

### 4.1 后端
- [x] 1. Survey实体添加slug字段
- [x] 2. 新增findBySlug接口
- [x] 3. 问卷CRUD支持slug
- [x] 4. 密码生成支持slug
- [ ] 5. 数据库清空并重新插入完整测试数据

### 4.2 H5前端
- [x] 1. 路由改造为动态路由
- [x] 2. PasswordVerify页面支持slug
- [x] 3. Question页面添加导航按钮
- [x] 4. 新增slug查询接口

### 4.3 管理后台
- [x] 1. 问卷表单添加slug字段
- [x] 2. 问卷列表显示slug
- [x] 3. 添加复制链接功能

---

## 五、验收标准

1. ✅ 每个问卷可设置唯一slug
2. ✅ 访问 `/{slug}` 正确加载问卷介绍
3. ✅ 输入密码后能正常答题
4. ✅ slug不允许重复
5. ✅ 能在管理后台复制问卷链接
6. ✅ H5答题页有明确的上一题/下一题导航

---

## 六、里程碑

| 阶段 | 内容 | 预计工作量 |
|------|------|----------|
| Phase 1 | 数据库改造 + 后端API | 1天 |
| Phase 2 | H5前端路由 + 页面改造 | 1天 |
| Phase 3 | 管理后台改造 + 测试 | 0.5天 |

---

## 七、数据处理

- **清空现有数据**：执行数据库脚本清空所有表
- **重新插入测试数据**：使用新的slug字段结构插入完整测试数据

---

## 八、附录

### 8.1 页面流程图
```
用户访问 /qwixn
    ↓
问卷介绍页（标题、描述、背景图）
    ↓
输入密码 → 验证
    ↓
开始答题
    ↓
完成 → 结果页
```

### 8.2 slug生成规则
- 推荐手动设置，便于记忆
- 系统自动生成：使用 nanoid 算法，6位字母数字
- 仅支持小写字母(a-z)和数字(0-9)
